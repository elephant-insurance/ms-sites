# glog
A small adapter package to integrate Elephant logging into gin. Allows full integration of custom logging and gin without dependency issues. Handles transactionId header for distributed tracing.

## Note: this README is out of date as of March 2021.

## Usage
To add request and response logging, just add the logging handler using the gin Use method:
```go
import (
  "github.com/gin-gonic/gin"
  nlog "github.com/elephant-insurance/gin-logging"
)
app := gin.New()
app.Use(nlog.New())
```
This will produce parsable, syslog-compliant log entries like these:
```
time="2018-07-12T16:18:44-04:00" level=info msg=Started app-name=my-app environment=dev hostname=snoopy method=GET path=/foobar
time="2018-07-12T16:18:44-04:00" level=info msg=Completed app-name=my-app elapsed="193.749Âµs" environment=dev hostname=snoopy method=GET path=/foobar status=404 status-text="Not Found"
```
To get rid of the "Started" messages, set
```go
nlog.LogRequestStart = false
```

## Transaction tracing and context logging
The logging handler will also intercept incoming calls and copy certain header values into the context, where they can be used to produce context-aware log messages that trace transactions across services.

By default, the handler looks for these four headers:
```
admiral-txid // a unique id generated by the app that initiates the transaction
admiral-txtype // a short description of what the transaction should do
admiral-txbrand // the brand associated with the request
admiral-txdomain // the domain of the account associated with the request
```
These values are stored in the context object, which in turn is stored in the http.Request object passed to the controllers. Each header is associated with a label which is used to tag log messages. For the four default headers, this looks like:
```
txid // the header 'admiral-txid: 12345' produces the log tag 'txid=12345'
txtype // 'admiral-txtype: "add a driver"'' produces 'txtype="add a driver"'
txbrand // 'admiral-txbrand: "elephant"' produces 'txbrand="elephant"'
txdomain // 'admiral-txdomain: "apparent"' produces 'txdomain="apparent"'
```
Note that you will need to pass the context object forward into any routines that produce log messages, and you will need to use the context-aware ("C"-prefixed) logging methods in order to see these additional tags.

When setting up your app, you can add additional headers to the context using the method `AddHeaderToContext(headerName, label string)`:
```go
// log the admiral-partner header as partner:
nlog.AddHeaderToContext("admiral-partner", "partner")
```
Similarly, headers (including the defaults) can be deactivated with `RemoveHeaderFromContext(headerName string)`:
```go
// We don't care about domain for this service:
RemoveHeaderFromContext("admiral-txdomain")
```
## Method suppression
To reduce noise in the logs from non-client requests, logging is disabled by default for the methods HEAD, CONNECT, OPTIONS, and TRACE. To enable logging for a method:
```go
nlog.EnableLogForMethod(http.MethodHead)
```
To disable automatic logging for a method:
```go
nlog.SuppressLogForMethod(http.MethodHead)
```

## HTTP Requests and the RequestWithHeaders methods
This package also partially wraps the very handy parnurzeal/gorequest library, which handles HTTP[S] communications in Go. If properly set-up, gin-logging ensures that tracking headers are forwarded to other services. To take advantage of this feature, instead of using the ```gorequest.New()``` command to create a gorequest SuperAgent, you will use one of these:
```go
nlog.PostRequestWithHeaders(c context.Context, url string) *gorequest.SuperAgent
nlog.GetRequestWithHeaders(c context.Context, url string) *gorequest.SuperAgent
nlog.PutRequestWithHeaders(c context.Context, url string) *gorequest.SuperAgent
nlog.PatchRequestWithHeaders(c context.Context, url string) *gorequest.SuperAgent
nlog.DeleteRequestWithHeaders(c context.Context, url string) *gorequest.SuperAgent
nlog.OptionsRequestWithHeaders(c context.Context, url string) *gorequest.SuperAgent
```
The SuperAgent struct returned from these methods is a full-fledged SuperAgent struct and may be treated as such. It's just been pre-configured to include tracking headers in every request.

As of version 1.4 (June 2019), all http requests generated by this package have a default timeout of 30 seconds. This is to prevent file handles from staying open indefinitely (the default behavior in Go) after a failed request.
